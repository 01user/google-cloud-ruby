<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <title>Gcloud::Pubsub &mdash; Gcloud Documentation</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="//googlecloudplatform.github.io/gcloud-ruby/css/normalize.css">
    <link rel="stylesheet" href="//googlecloudplatform.github.io/gcloud-ruby/css/main.css">
    <script src="//googlecloudplatform.github.io/gcloud-ruby/js/vendor/modernizr-2.6.2.min.js"></script>
    <link href='//fonts.googleapis.com/css?family=Droid+Sans+Mono|Roboto:300,400,700,700italic,400italic|Open+Sans:300' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" href="https://cloud.google.com/images/gcp-favicon.ico">
  </head>

  <body class="lang-page">
    <!--[if lt IE 7]>
      <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->

    <header class="page-header fixed" role="banner">
      <h1 class="logo">
        <a href="//googlecloudplatform.github.io/gcloud-ruby/" title="back to home">
          <img src="//googlecloudplatform.github.io/gcloud-ruby/img/logo.svg" alt="Google Cloud Platform">
          <span class="gcloud">gcloud</span>
        </a>
      </h1>

      <nav class="main-nav">
        <div class="nav-current">Ruby</div>
        <ul class="menu">
          <li>
            <a href="//googlecloudplatform.github.io/gcloud-java/" title="gcloud-java">
              <img src="//googlecloudplatform.github.io/gcloud-ruby/img/icon-lang-java.svg" alt="Java icon" class="menu-icon" />
              Java
            </a>
          </li>
          <li>
            <a href="//googlecloudplatform.github.io/gcloud-node/#/docs" title="gcloud-node">
              <img src="//googlecloudplatform.github.io/gcloud-ruby/img/icon-lang-nodejs.svg" alt="Node.js icon" class="menu-icon">
              Node.js
            </a>
          </li>
          <li>
            <a href="//googlecloudplatform.github.io/gcloud-python/latest/" title="gcloud-python">
              <img src="//googlecloudplatform.github.io/gcloud-ruby/img/icon-lang-python.svg" alt="Python icon" class="menu-icon">
              Python
            </a>
          </li>
          <li>
            <a href="//googlecloudplatform.github.io/gcloud-ruby/" title="gcloud-ruby">
              <img src="//googlecloudplatform.github.io/gcloud-ruby/img/icon-lang-ruby.svg" alt="Ruby icon" class="menu-icon" width="24">
              Ruby
            </a>
          </li>
        </ul>
      </nav>

      <div class="github-issue">
        <a href="https://github.com/GoogleCloudPlatform/gcloud-ruby/issues/new?title=%5BDocumentation+Issue%5D+" target="_blank" class="v-btn">
          <img src="//googlecloudplatform.github.io/gcloud-ruby/img/icon-link-github.svg" />
          Report an Issue
        </a>
      </div>
    </header>

    <article class="main lang-page" role="main">

      <header class="docs-header">
        <h1 class="page-title">Gcloud::Pubsub</h1>
      </header>

      <section class="content">

        <div id="description" class="description">
          <h1 id="google-cloud-pubsub">Google Cloud Pub/Sub</h1>

<p>Google Cloud Pub/Sub is designed to provide reliable, many-to-many,
asynchronous messaging between applications. Publisher applications can
send messages to a “topic” and other applications can subscribe to that
topic to receive the messages. By decoupling senders and receivers, Google
Cloud Pub/Sub allows developers to communicate between independently written
applications.</p>

<p>The goal of gcloud-ruby is to provide a API that is comfortable to
Rubyists. Authentication is handled by <span class='object_link'><a href="../Gcloud.html#pubsub-instance_method" title="Gcloud#pubsub (method)">#pubsub</a></span>. You can provide the
project and credential information to connect to the Pub/Sub service, or if
you are running on Google Compute Engine this configuration is taken care
of for you.</p>

<div class="language-ruby highlighter-rouge"><pre class="ruby"><code><span class="nb">require</span> <span class="s2">"gcloud"</span>

<span class="n">gcloud</span> <span class="o">=</span> <span class="no">Gcloud</span><span class="p">.</span><span class="nf">new</span>
<span class="n">pubsub</span> <span class="o">=</span> <span class="n">gcloud</span><span class="p">.</span><span class="nf">pubsub</span>

<span class="n">topic</span> <span class="o">=</span> <span class="n">pubsub</span><span class="p">.</span><span class="nf">topic</span> <span class="s2">"my-topic"</span>
<span class="n">topic</span><span class="p">.</span><span class="nf">publish</span> <span class="s2">"task completed"</span>
</code></pre>
</div>

<p>To learn more about Pub/Sub, read the <a href="https://cloud.google.com/pubsub/overview">Google Cloud Pub/Sub Overview
</a>.</p>

<h2 id="retrieving-topics">Retrieving Topics</h2>

<p>A Topic is a named resource to which messages are sent by publishers.
A Topic is found by its name. (See <span class='object_link'><a href="Pubsub/Project.html#topic-instance_method" title="Gcloud::Pubsub::Project#topic (method)">Project#topic</a></span>)</p>

<div class="language-ruby highlighter-rouge"><pre class="ruby"><code><span class="nb">require</span> <span class="s2">"gcloud"</span>

<span class="n">gcloud</span> <span class="o">=</span> <span class="no">Gcloud</span><span class="p">.</span><span class="nf">new</span>
<span class="n">pubsub</span> <span class="o">=</span> <span class="n">gcloud</span><span class="p">.</span><span class="nf">pubsub</span>
<span class="n">topic</span> <span class="o">=</span> <span class="n">pubsub</span><span class="p">.</span><span class="nf">topic</span> <span class="s2">"my-topic"</span>
</code></pre>
</div>

<h2 id="creating-a-topic">Creating a Topic</h2>

<p>A Topic is created from a Project. (See
<span class='object_link'><a href="Pubsub/Project.html#create_topic-instance_method" title="Gcloud::Pubsub::Project#create_topic (method)">Project#create_topic</a></span>)</p>

<div class="language-ruby highlighter-rouge"><pre class="ruby"><code><span class="nb">require</span> <span class="s2">"gcloud"</span>

<span class="n">gcloud</span> <span class="o">=</span> <span class="no">Gcloud</span><span class="p">.</span><span class="nf">new</span>
<span class="n">pubsub</span> <span class="o">=</span> <span class="n">gcloud</span><span class="p">.</span><span class="nf">pubsub</span>
<span class="n">topic</span> <span class="o">=</span> <span class="n">pubsub</span><span class="p">.</span><span class="nf">create_topic</span> <span class="s2">"my-topic"</span>
</code></pre>
</div>

<h2 id="retrieving-subscriptions">Retrieving Subscriptions</h2>

<p>A Subscription is a named resource representing the stream of messages from
a single, specific Topic, to be delivered to the subscribing application. A
Subscription is found by its name. (See
<span class='object_link'><a href="Pubsub/Topic.html#subscription-instance_method" title="Gcloud::Pubsub::Topic#subscription (method)">Topic#subscription</a></span>)</p>

<div class="language-ruby highlighter-rouge"><pre class="ruby"><code><span class="nb">require</span> <span class="s2">"gcloud"</span>

<span class="n">gcloud</span> <span class="o">=</span> <span class="no">Gcloud</span><span class="p">.</span><span class="nf">new</span>
<span class="n">pubsub</span> <span class="o">=</span> <span class="n">gcloud</span><span class="p">.</span><span class="nf">pubsub</span>

<span class="n">topic</span> <span class="o">=</span> <span class="n">pubsub</span><span class="p">.</span><span class="nf">topic</span> <span class="s2">"my-topic"</span>
<span class="n">subscription</span> <span class="o">=</span> <span class="n">topic</span><span class="p">.</span><span class="nf">subscription</span> <span class="s2">"my-topic-subscription"</span>
<span class="nb">puts</span> <span class="n">subscription</span><span class="p">.</span><span class="nf">name</span>
</code></pre>
</div>

<h2 id="creating-a-subscription">Creating a Subscription</h2>

<p>A Subscription is created from a Topic. (See
<span class='object_link'><a href="Pubsub/Topic.html#subscribe-instance_method" title="Gcloud::Pubsub::Topic#subscribe (method)">Topic#subscribe</a></span> and <span class='object_link'><a href="Pubsub/Project.html#subscribe-instance_method" title="Gcloud::Pubsub::Project#subscribe (method)">Project#subscribe</a></span>)</p>

<div class="language-ruby highlighter-rouge"><pre class="ruby"><code><span class="nb">require</span> <span class="s2">"gcloud"</span>

<span class="n">gcloud</span> <span class="o">=</span> <span class="no">Gcloud</span><span class="p">.</span><span class="nf">new</span>
<span class="n">pubsub</span> <span class="o">=</span> <span class="n">gcloud</span><span class="p">.</span><span class="nf">pubsub</span>

<span class="n">topic</span> <span class="o">=</span> <span class="n">pubsub</span><span class="p">.</span><span class="nf">topic</span> <span class="s2">"my-topic"</span>
<span class="nb">sub</span> <span class="o">=</span> <span class="n">topic</span><span class="p">.</span><span class="nf">subscribe</span> <span class="s2">"my-topic-sub"</span>
<span class="nb">puts</span> <span class="nb">sub</span><span class="p">.</span><span class="nf">name</span> <span class="c1"># =&gt; "my-topic-sub"</span>
</code></pre>
</div>

<p>The subscription can be created that specifies the number of seconds to
wait to be acknowledged as well as an endpoint URL to push the messages to:</p>

<div class="language-ruby highlighter-rouge"><pre class="ruby"><code><span class="nb">require</span> <span class="s2">"gcloud"</span>

<span class="n">gcloud</span> <span class="o">=</span> <span class="no">Gcloud</span><span class="p">.</span><span class="nf">new</span>
<span class="n">pubsub</span> <span class="o">=</span> <span class="n">gcloud</span><span class="p">.</span><span class="nf">pubsub</span>

<span class="n">topic</span> <span class="o">=</span> <span class="n">pubsub</span><span class="p">.</span><span class="nf">topic</span> <span class="s2">"my-topic"</span>
<span class="nb">sub</span> <span class="o">=</span> <span class="n">topic</span><span class="p">.</span><span class="nf">subscribe</span> <span class="s2">"my-topic-sub"</span><span class="p">,</span>
                      <span class="ss">deadline: </span><span class="mi">120</span><span class="p">,</span>
                      <span class="ss">endpoint: </span><span class="s2">"https://example.com/push"</span>
</code></pre>
</div>

<h2 id="publishing-messages">Publishing Messages</h2>

<p>Messages are published to a topic. Any message published to a topic without
a subscription will be lost. Ensure the topic has a subscription before
publishing. (See <span class='object_link'><a href="Pubsub/Topic.html#publish-instance_method" title="Gcloud::Pubsub::Topic#publish (method)">Topic#publish</a></span> and
<span class='object_link'><a href="Pubsub/Project.html#publish-instance_method" title="Gcloud::Pubsub::Project#publish (method)">Project#publish</a></span>)</p>

<div class="language-ruby highlighter-rouge"><pre class="ruby"><code><span class="nb">require</span> <span class="s2">"gcloud"</span>

<span class="n">gcloud</span> <span class="o">=</span> <span class="no">Gcloud</span><span class="p">.</span><span class="nf">new</span>
<span class="n">pubsub</span> <span class="o">=</span> <span class="n">gcloud</span><span class="p">.</span><span class="nf">pubsub</span>

<span class="n">topic</span> <span class="o">=</span> <span class="n">pubsub</span><span class="p">.</span><span class="nf">topic</span> <span class="s2">"my-topic"</span>
<span class="n">msg</span> <span class="o">=</span> <span class="n">topic</span><span class="p">.</span><span class="nf">publish</span> <span class="s2">"new-message"</span>
</code></pre>
</div>

<p>Messages can also be published with attributes:</p>

<div class="language-ruby highlighter-rouge"><pre class="ruby"><code><span class="nb">require</span> <span class="s2">"gcloud"</span>

<span class="n">gcloud</span> <span class="o">=</span> <span class="no">Gcloud</span><span class="p">.</span><span class="nf">new</span>
<span class="n">pubsub</span> <span class="o">=</span> <span class="n">gcloud</span><span class="p">.</span><span class="nf">pubsub</span>

<span class="n">topic</span> <span class="o">=</span> <span class="n">pubsub</span><span class="p">.</span><span class="nf">topic</span> <span class="s2">"my-topic"</span>
<span class="n">msg</span> <span class="o">=</span> <span class="n">topic</span><span class="p">.</span><span class="nf">publish</span> <span class="s2">"new-message"</span><span class="p">,</span>
                    <span class="ss">foo: :bar</span><span class="p">,</span>
                    <span class="ss">this: :that</span>
</code></pre>
</div>

<p>Multiple messages can be published at the same time by passing a block:</p>

<div class="language-ruby highlighter-rouge"><pre class="ruby"><code><span class="nb">require</span> <span class="s2">"gcloud"</span>

<span class="n">gcloud</span> <span class="o">=</span> <span class="no">Gcloud</span><span class="p">.</span><span class="nf">new</span>
<span class="n">pubsub</span> <span class="o">=</span> <span class="n">gcloud</span><span class="p">.</span><span class="nf">pubsub</span>

<span class="n">topic</span> <span class="o">=</span> <span class="n">pubsub</span><span class="p">.</span><span class="nf">topic</span> <span class="s2">"my-topic"</span>
<span class="n">msgs</span> <span class="o">=</span> <span class="n">topic</span><span class="p">.</span><span class="nf">publish</span> <span class="k">do</span> <span class="o">|</span><span class="n">batch</span><span class="o">|</span>
  <span class="n">batch</span><span class="p">.</span><span class="nf">publish</span> <span class="s2">"new-message-1"</span><span class="p">,</span> <span class="ss">foo: :bar</span>
  <span class="n">batch</span><span class="p">.</span><span class="nf">publish</span> <span class="s2">"new-message-2"</span><span class="p">,</span> <span class="ss">foo: :baz</span>
  <span class="n">batch</span><span class="p">.</span><span class="nf">publish</span> <span class="s2">"new-message-3"</span><span class="p">,</span> <span class="ss">foo: :bif</span>
<span class="k">end</span>
</code></pre>
</div>

<h2 id="pulling-messages">Pulling Messages</h2>

<p>Messages are pulled from a Subscription. (See
<span class='object_link'><a href="Pubsub/Subscription.html#pull-instance_method" title="Gcloud::Pubsub::Subscription#pull (method)">Subscription#pull</a></span>)</p>

<div class="language-ruby highlighter-rouge"><pre class="ruby"><code><span class="nb">require</span> <span class="s2">"gcloud"</span>

<span class="n">gcloud</span> <span class="o">=</span> <span class="no">Gcloud</span><span class="p">.</span><span class="nf">new</span>
<span class="n">pubsub</span> <span class="o">=</span> <span class="n">gcloud</span><span class="p">.</span><span class="nf">pubsub</span>

<span class="nb">sub</span> <span class="o">=</span> <span class="n">pubsub</span><span class="p">.</span><span class="nf">subscription</span> <span class="s2">"my-topic-sub"</span>
<span class="n">msgs</span> <span class="o">=</span> <span class="nb">sub</span><span class="p">.</span><span class="nf">pull</span>
</code></pre>
</div>

<p>A maximum number of messages returned can also be specified:</p>

<div class="language-ruby highlighter-rouge"><pre class="ruby"><code><span class="nb">require</span> <span class="s2">"gcloud"</span>

<span class="n">gcloud</span> <span class="o">=</span> <span class="no">Gcloud</span><span class="p">.</span><span class="nf">new</span>
<span class="n">pubsub</span> <span class="o">=</span> <span class="n">gcloud</span><span class="p">.</span><span class="nf">pubsub</span>

<span class="nb">sub</span> <span class="o">=</span> <span class="n">pubsub</span><span class="p">.</span><span class="nf">subscription</span> <span class="s2">"my-topic-sub"</span><span class="p">,</span> <span class="ss">max: </span><span class="mi">10</span>
<span class="n">msgs</span> <span class="o">=</span> <span class="nb">sub</span><span class="p">.</span><span class="nf">pull</span>
</code></pre>
</div>

<p>The request for messages can also block until messages are available.
(See <span class='object_link'><a href="Pubsub/Subscription.html#wait_for_messages-instance_method" title="Gcloud::Pubsub::Subscription#wait_for_messages (method)">Subscription#wait_for_messages</a></span>)</p>

<div class="language-ruby highlighter-rouge"><pre class="ruby"><code><span class="nb">require</span> <span class="s2">"gcloud"</span>

<span class="n">gcloud</span> <span class="o">=</span> <span class="no">Gcloud</span><span class="p">.</span><span class="nf">new</span>
<span class="n">pubsub</span> <span class="o">=</span> <span class="n">gcloud</span><span class="p">.</span><span class="nf">pubsub</span>

<span class="nb">sub</span> <span class="o">=</span> <span class="n">pubsub</span><span class="p">.</span><span class="nf">subscription</span> <span class="s2">"my-topic-sub"</span>
<span class="n">msgs</span> <span class="o">=</span> <span class="nb">sub</span><span class="p">.</span><span class="nf">wait_for_messages</span>
</code></pre>
</div>

<h2 id="acknowledging-a-message">Acknowledging a Message</h2>

<p>Messages that are received can be acknowledged in Pub/Sub, marking the
message to be removed so it cannot be pulled again.</p>

<p>A Message that can be acknowledged is called a ReceivedMessage.
ReceivedMessages can be acknowledged one at a time:
(See <span class='object_link'><a href="Pubsub/ReceivedMessage.html#acknowledge%21-instance_method" title="Gcloud::Pubsub::ReceivedMessage#acknowledge! (method)">ReceivedMessage#acknowledge!</a></span>)</p>

<div class="language-ruby highlighter-rouge"><pre class="ruby"><code><span class="nb">require</span> <span class="s2">"gcloud"</span>

<span class="n">gcloud</span> <span class="o">=</span> <span class="no">Gcloud</span><span class="p">.</span><span class="nf">new</span>
<span class="n">pubsub</span> <span class="o">=</span> <span class="n">gcloud</span><span class="p">.</span><span class="nf">pubsub</span>

<span class="nb">sub</span> <span class="o">=</span> <span class="n">pubsub</span><span class="p">.</span><span class="nf">subscription</span> <span class="s2">"my-topic-sub"</span>
<span class="nb">sub</span><span class="p">.</span><span class="nf">pull</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span> <span class="n">msg</span><span class="p">.</span><span class="nf">acknowledge!</span> <span class="p">}</span>
</code></pre>
</div>

<p>Or, multiple messages can be acknowledged in a single API call:
(See <span class='object_link'><a href="Pubsub/Subscription.html#acknowledge-instance_method" title="Gcloud::Pubsub::Subscription#acknowledge (method)">Subscription#acknowledge</a></span>)</p>

<div class="language-ruby highlighter-rouge"><pre class="ruby"><code><span class="nb">require</span> <span class="s2">"gcloud"</span>

<span class="n">gcloud</span> <span class="o">=</span> <span class="no">Gcloud</span><span class="p">.</span><span class="nf">new</span>
<span class="n">pubsub</span> <span class="o">=</span> <span class="n">gcloud</span><span class="p">.</span><span class="nf">pubsub</span>

<span class="nb">sub</span> <span class="o">=</span> <span class="n">pubsub</span><span class="p">.</span><span class="nf">subscription</span> <span class="s2">"my-topic-sub"</span>
<span class="n">received_messages</span> <span class="o">=</span> <span class="nb">sub</span><span class="p">.</span><span class="nf">pull</span>
<span class="nb">sub</span><span class="p">.</span><span class="nf">acknowledge</span> <span class="n">received_messages</span>
</code></pre>
</div>

<h2 id="modifying-a-deadline">Modifying a Deadline</h2>

<p>A message must be acknowledged after it is pulled, or Pub/Sub will mark the
message for redelivery. The message acknowledgement deadline can delayed if
more time is needed. This will allow more time to process the message before
the message is marked for redelivery. (See
<span class='object_link'><a href="Pubsub/ReceivedMessage.html#delay%21-instance_method" title="Gcloud::Pubsub::ReceivedMessage#delay! (method)">ReceivedMessage#delay!</a></span>)</p>

<div class="language-ruby highlighter-rouge"><pre class="ruby"><code><span class="nb">require</span> <span class="s2">"gcloud"</span>

<span class="n">gcloud</span> <span class="o">=</span> <span class="no">Gcloud</span><span class="p">.</span><span class="nf">new</span>
<span class="n">pubsub</span> <span class="o">=</span> <span class="n">gcloud</span><span class="p">.</span><span class="nf">pubsub</span>

<span class="nb">sub</span> <span class="o">=</span> <span class="n">pubsub</span><span class="p">.</span><span class="nf">subscription</span> <span class="s2">"my-topic-sub"</span>
<span class="n">received_message</span> <span class="o">=</span> <span class="nb">sub</span><span class="p">.</span><span class="nf">pull</span><span class="p">.</span><span class="nf">first</span>
<span class="k">if</span> <span class="n">received_message</span>
  <span class="nb">puts</span> <span class="n">received_message</span><span class="p">.</span><span class="nf">message</span><span class="p">.</span><span class="nf">data</span>
  <span class="c1"># Delay for 2 minutes</span>
  <span class="n">received_message</span><span class="p">.</span><span class="nf">delay!</span> <span class="mi">120</span>
<span class="k">end</span>
</code></pre>
</div>

<p>The message can also be made available for immediate redelivery:</p>

<div class="language-ruby highlighter-rouge"><pre class="ruby"><code><span class="nb">require</span> <span class="s2">"gcloud"</span>

<span class="n">gcloud</span> <span class="o">=</span> <span class="no">Gcloud</span><span class="p">.</span><span class="nf">new</span>
<span class="n">pubsub</span> <span class="o">=</span> <span class="n">gcloud</span><span class="p">.</span><span class="nf">pubsub</span>

<span class="nb">sub</span> <span class="o">=</span> <span class="n">pubsub</span><span class="p">.</span><span class="nf">subscription</span> <span class="s2">"my-topic-sub"</span>
<span class="n">received_message</span> <span class="o">=</span> <span class="nb">sub</span><span class="p">.</span><span class="nf">pull</span><span class="p">.</span><span class="nf">first</span>
<span class="k">if</span> <span class="n">received_message</span>
  <span class="nb">puts</span> <span class="n">received_message</span><span class="p">.</span><span class="nf">message</span><span class="p">.</span><span class="nf">data</span>
  <span class="c1"># Mark for redelivery by setting the deadline to now</span>
  <span class="n">received_message</span><span class="p">.</span><span class="nf">delay!</span> <span class="mi">0</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Multiple messages can be delayed or made available for immediate redelivery:
(See <span class='object_link'><a href="Pubsub/Subscription.html#delay-instance_method" title="Gcloud::Pubsub::Subscription#delay (method)">Subscription#delay</a></span>)</p>

<div class="language-ruby highlighter-rouge"><pre class="ruby"><code><span class="nb">require</span> <span class="s2">"gcloud"</span>

<span class="n">gcloud</span> <span class="o">=</span> <span class="no">Gcloud</span><span class="p">.</span><span class="nf">new</span>
<span class="n">pubsub</span> <span class="o">=</span> <span class="n">gcloud</span><span class="p">.</span><span class="nf">pubsub</span>

<span class="nb">sub</span> <span class="o">=</span> <span class="n">pubsub</span><span class="p">.</span><span class="nf">subscription</span> <span class="s2">"my-topic-sub"</span>
<span class="n">received_messages</span> <span class="o">=</span> <span class="nb">sub</span><span class="p">.</span><span class="nf">pull</span>
<span class="nb">sub</span><span class="p">.</span><span class="nf">delay</span> <span class="mi">120</span><span class="p">,</span> <span class="n">received_messages</span>
</code></pre>
</div>

<h2 id="listening-for-messages">Listening for Messages</h2>

<p>Long running workers are easy to create with <code class="highlighter-rouge">listen</code>, which runs an
infinitely blocking loop to process messages as they are received. (See
<span class='object_link'><a href="Pubsub/Subscription.html#listen-instance_method" title="Gcloud::Pubsub::Subscription#listen (method)">Subscription#listen</a></span>)</p>

<div class="language-ruby highlighter-rouge"><pre class="ruby"><code><span class="nb">require</span> <span class="s2">"gcloud"</span>

<span class="n">gcloud</span> <span class="o">=</span> <span class="no">Gcloud</span><span class="p">.</span><span class="nf">new</span>
<span class="n">pubsub</span> <span class="o">=</span> <span class="n">gcloud</span><span class="p">.</span><span class="nf">pubsub</span>

<span class="nb">sub</span> <span class="o">=</span> <span class="n">pubsub</span><span class="p">.</span><span class="nf">subscription</span> <span class="s2">"my-topic-sub"</span>
<span class="nb">sub</span><span class="p">.</span><span class="nf">listen</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span>
  <span class="c1"># process msg</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Messages are retrieved in batches for efficiency. The number of messages
pulled per batch can be limited with the <code class="highlighter-rouge">max</code> option:</p>

<div class="language-ruby highlighter-rouge"><pre class="ruby"><code><span class="nb">require</span> <span class="s2">"gcloud"</span>

<span class="n">gcloud</span> <span class="o">=</span> <span class="no">Gcloud</span><span class="p">.</span><span class="nf">new</span>
<span class="n">pubsub</span> <span class="o">=</span> <span class="n">gcloud</span><span class="p">.</span><span class="nf">pubsub</span>

<span class="nb">sub</span> <span class="o">=</span> <span class="n">pubsub</span><span class="p">.</span><span class="nf">subscription</span> <span class="s2">"my-topic-sub"</span>
<span class="nb">sub</span><span class="p">.</span><span class="nf">listen</span> <span class="ss">max: </span><span class="mi">20</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span>
  <span class="c1"># process msg</span>
<span class="k">end</span>
</code></pre>
</div>

<p>When processing time and the acknowledgement deadline are a concern,
messages can be automatically acknowledged as they are pulled with the
<code class="highlighter-rouge">autoack</code> option:</p>

<div class="language-ruby highlighter-rouge"><pre class="ruby"><code><span class="nb">require</span> <span class="s2">"gcloud"</span>

<span class="n">gcloud</span> <span class="o">=</span> <span class="no">Gcloud</span><span class="p">.</span><span class="nf">new</span>
<span class="n">pubsub</span> <span class="o">=</span> <span class="n">gcloud</span><span class="p">.</span><span class="nf">pubsub</span>

<span class="nb">sub</span> <span class="o">=</span> <span class="n">pubsub</span><span class="p">.</span><span class="nf">subscription</span> <span class="s2">"my-topic-sub"</span>
<span class="nb">sub</span><span class="p">.</span><span class="nf">listen</span> <span class="ss">autoack: </span><span class="kp">true</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span>
  <span class="c1"># process msg</span>
<span class="k">end</span>
</code></pre>
</div>

<h2 id="configuring-retries-and-timeout">Configuring retries and timeout</h2>

<p>You can configure how many times API requests may be automatically retried.
When an API request fails, the response will be inspected to see if the
request meets criteria indicating that it may succeed on retry, such as
<code class="highlighter-rouge">500</code> and <code class="highlighter-rouge">503</code> status codes or a specific internal error code such as
<code class="highlighter-rouge">rateLimitExceeded</code>. If it meets the criteria, the request will be retried
after a delay. If another error occurs, the delay will be increased before a
subsequent attempt, until the <code class="highlighter-rouge">retries</code> limit is reached.</p>

<p>You can also set the request <code class="highlighter-rouge">timeout</code> value in seconds.</p>

<div class="language-ruby highlighter-rouge"><pre class="ruby"><code><span class="nb">require</span> <span class="s2">"gcloud"</span>

<span class="n">gcloud</span> <span class="o">=</span> <span class="no">Gcloud</span><span class="p">.</span><span class="nf">new</span>
<span class="n">pubsub</span> <span class="o">=</span> <span class="n">gcloud</span><span class="p">.</span><span class="nf">pubsub</span> <span class="ss">retries: </span><span class="mi">10</span><span class="p">,</span> <span class="ss">timeout: </span><span class="mi">120</span>
</code></pre>
</div>

<p>See the <a href="https://cloud.google.com/pubsub/error-codes">Pub/Sub error codes</a>
for a list of error conditions.</p>

<h2 id="working-across-projects">Working Across Projects</h2>

<p>All calls to the Pub/Sub service use the same project and credentials
provided to the <span class='object_link'><a href="../Gcloud.html#pubsub-instance_method" title="Gcloud#pubsub (method)">#pubsub</a></span> method. However, it is common to reference
topics or subscriptions in other projects, which can be achieved by using
the <code class="highlighter-rouge">project</code> option. The main credentials must have permissions to the
topics and subscriptions in other projects.</p>

<div class="language-ruby highlighter-rouge"><pre class="ruby"><code><span class="nb">require</span> <span class="s2">"gcloud"</span>

<span class="n">gcloud</span> <span class="o">=</span> <span class="no">Gcloud</span><span class="p">.</span><span class="nf">new</span> <span class="c1"># my-project-id</span>
<span class="n">pubsub</span> <span class="o">=</span> <span class="n">gcloud</span><span class="p">.</span><span class="nf">pubsub</span>

<span class="c1"># Get a topic in the current project</span>
<span class="n">my_topic</span> <span class="o">=</span> <span class="n">pubsub</span><span class="p">.</span><span class="nf">topic</span> <span class="s2">"my-topic"</span>
<span class="n">my_topic</span><span class="p">.</span><span class="nf">name</span> <span class="c1">#=&gt; "projects/my-project-id/topics/my-topic"</span>
<span class="c1"># Get a topic in another project</span>
<span class="n">other_topic</span> <span class="o">=</span> <span class="n">pubsub</span><span class="p">.</span><span class="nf">topic</span> <span class="s2">"other-topic"</span><span class="p">,</span> <span class="ss">project: </span><span class="s2">"other-project-id"</span>
<span class="n">other_topic</span><span class="p">.</span><span class="nf">name</span> <span class="c1">#=&gt; "projects/other-project-id/topics/other-topic"</span>
</code></pre>
</div>

<p>It is possible to create a subscription in the current project that pulls
from a topic in another project:</p>

<div class="language-ruby highlighter-rouge"><pre class="ruby"><code><span class="nb">require</span> <span class="s2">"gcloud"</span>

<span class="n">gcloud</span> <span class="o">=</span> <span class="no">Gcloud</span><span class="p">.</span><span class="nf">new</span> <span class="c1"># my-project-id</span>
<span class="n">pubsub</span> <span class="o">=</span> <span class="n">gcloud</span><span class="p">.</span><span class="nf">pubsub</span>

<span class="c1"># Get a topic in another project</span>
<span class="n">topic</span> <span class="o">=</span> <span class="n">pubsub</span><span class="p">.</span><span class="nf">topic</span> <span class="s2">"other-topic"</span><span class="p">,</span> <span class="ss">project: </span><span class="s2">"other-project-id"</span>
<span class="c1"># Create a subscription in the current project that pulls from</span>
<span class="c1"># the topic in another project</span>
<span class="nb">sub</span> <span class="o">=</span> <span class="n">topic</span><span class="p">.</span><span class="nf">subscribe</span> <span class="s2">"my-sub"</span>
<span class="nb">sub</span><span class="p">.</span><span class="nf">name</span> <span class="c1">#=&gt; "projects/my-project-id/subscriptions/my-sub"</span>
<span class="nb">sub</span><span class="p">.</span><span class="nf">topic</span><span class="p">.</span><span class="nf">name</span> <span class="c1">#=&gt; "projects/other-project-id/topics/other-topic"</span>
</code></pre>
</div>

<h2 id="using-the-google-cloud-pubsub-emulator">Using the Google Cloud Pub/Sub Emulator</h2>

<p>To develop and test your application locally, you can use the <a href="https://cloud.google.com/pubsub/emulator">Google Cloud
Pub/Sub Emulator</a>, which provides
<a href="https://cloud.google.com/sdk/gcloud/reference/beta/emulators/">local
emulation</a> of
the production Google Cloud Pub/Sub environment. You can start the Google
Cloud Pub/Sub emulator using the <code class="highlighter-rouge">gcloud</code> command-line tool.</p>

<p>To configure your ruby code to use the emulator, set the
<code class="highlighter-rouge">PUBSUB_EMULATOR_HOST</code> environment variable to the host and port where the
emulator is running. The value can be set as an environment variable in the
shell running the ruby code, or can be set directly in the ruby code as
shown below.</p>

<div class="language-ruby highlighter-rouge"><pre class="ruby"><code><span class="nb">require</span> <span class="s2">"gcloud"</span>

<span class="c1"># Make Pub/Sub use the emulator</span>
<span class="no">ENV</span><span class="p">[</span><span class="s2">"PUBSUB_EMULATOR_HOST"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"localhost:8918"</span>

<span class="n">gcloud</span> <span class="o">=</span> <span class="no">Gcloud</span><span class="p">.</span><span class="nf">new</span> <span class="s2">"emulator-project-id"</span>
<span class="n">pubsub</span> <span class="o">=</span> <span class="n">gcloud</span><span class="p">.</span><span class="nf">pubsub</span>

<span class="c1"># Get a topic in the current project</span>
<span class="n">my_topic</span> <span class="o">=</span> <span class="n">pubsub</span><span class="p">.</span><span class="nf">new_topic</span> <span class="s2">"my-topic"</span>
<span class="n">my_topic</span><span class="p">.</span><span class="nf">name</span> <span class="c1">#=&gt; "projects/emulator-project-id/topics/my-topic"</span>
</code></pre>
</div>

        </div>

        <div class="section-links">
          

          
          

          
        </div>

        
      </section>

      <nav class="side-nav">

        <div class="side-nav--meta"><div id="doc-build-date">Docs built on Aug 09, 2016.</div></div><ul><h4 class="list-item--heading">Getting Started</h4><li class='toc-l0'><a class='reference internal' href='../index.html'>Overview</a></li><li class='toc-l0'><a class='reference internal' href='../AUTHENTICATION.html'>Authentication Guide</a></li></ul><ul><h4 class="list-item--heading">API</h4><li class='toc-l0'><a class='reference internal' href='../Gcloud.html'>Gcloud</a></li><li class='toc-l0'><a class='reference internal' href='Bigquery.html'>BigQuery</a></li><li class='toc-l0'><a class='reference internal' href='Datastore.html'>Datastore</a></li><li class='toc-l0'><a class='reference internal' href='Dns.html'>DNS</a></li><li class='toc-l0'><a class='reference internal' href='Logging.html'>Logging</a></li><li class='toc-l0'><a class='reference internal current' href=''>Pub/Sub</a></li><li class='toc-l1'><a class='reference internal' href='Pubsub/Project.html'>Project</a></li><li class='toc-l1'><a class='reference internal' href='Pubsub/Topic.html'>Topic</a></li><li class='toc-l1'><a class='reference internal' href='Pubsub/Subscription.html'>Subscription</a></li><li class='toc-l0'><a class='reference internal' href='ResourceManager.html'>Resource Manager</a></li><li class='toc-l0'><a class='reference internal' href='Storage.html'>Storage</a></li><li class='toc-l0'><a class='reference internal' href='Translate.html'>Translate</a></li><li class='toc-l0'><a class='reference internal' href='../reference.html'>API Reference</a></li></ul>

        <ul class="external-links">
          <li>
            <a href="https://github.com/GoogleCloudPlatform/gcloud-ruby" title="Github repository">
              <img src="//googlecloudplatform.github.io/gcloud-ruby/img/icon-link-github.svg" alt="Github icon">
              Github
            </a>
          </li>
          <li>
            <a href="https://github.com/GoogleCloudPlatform/gcloud-ruby/issues" title="Issues on Github">
              <img src="//googlecloudplatform.github.io/gcloud-ruby/img/icon-link-issues.svg" alt="Issues icon">
              Issues
            </a>
          </li>
          <li>
            <a href="http://stackoverflow.com/questions/tagged/gcloud-ruby" title="gcloud on StackOverflow">
              <img src="//googlecloudplatform.github.io/gcloud-ruby/img/icon-link-stackoverflow.svg" alt="StackOverflow icon">
              StackOverflow
            </a>
          </li>
          <li>
            <a href="http://rubygems.org/gems/gcloud" title="RubyGems" class="ext-link">
               <img src="//googlecloudplatform.github.io/gcloud-ruby/img/icon-link-rubygems.svg" alt="RubyGems icon">
              RubyGems
            </a>
          </li>
        </ul>

      </nav>

    </article>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script ="//googlecloudplatform.github.io/gcloud-ruby/js/vendor/jquery-1.10.2.min.js"><\/script>')</script>
    <script src="//googlecloudplatform.github.io/gcloud-ruby/js/plugins.js"></script>
    <script src="//googlecloudplatform.github.io/gcloud-ruby/js/main.js"></script>

    <script>
      (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
      function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
      e=o.createElement(i);r=o.getElementsByTagName(i)[0];
      e.src='//www.google-analytics.com/analytics.js';
      r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
      ga('create','UA-49880327-13');ga('send','pageview');
    </script>

  </body>
</html>
